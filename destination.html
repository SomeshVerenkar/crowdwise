<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destination - CrowdWise India</title>
    <meta name="description" content="Real-time crowd prediction for Indian tourist destinations. Check crowd levels and plan your visit.">
    <link rel="stylesheet" href="styles.css?v=3.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ===== DESTINATION PAGE STYLES ===== */
        .dest-page { max-width: 900px; margin: 0 auto; padding: 24px 16px 60px; }

        .dest-back { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; color: var(--primary); text-decoration: none; margin-bottom: 20px; }
        .dest-back:hover { text-decoration: underline; }

        /* Hero card */
        .dest-hero { position: relative; border-radius: 20px; overflow: hidden; min-height: 220px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: flex-end; margin-bottom: 24px; }
        .dest-hero-img { position: absolute; inset: 0; background-size: cover; background-position: center; }
        .dest-hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.1) 60%); }
        .dest-hero-info { position: relative; z-index: 1; padding: 24px; width: 100%; color: #fff; }
        .dest-hero-name { font-size: 28px; font-weight: 800; margin: 0 0 4px; }
        .dest-hero-state { font-size: 14px; opacity: 0.9; }
        .dest-hero-badges { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .dest-hero-badge { padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; backdrop-filter: blur(8px); }
        .dest-hero-badge.crowd { background: rgba(255,255,255,0.25); }
        .dest-hero-badge.best-time { background: rgba(255,255,255,0.2); }

        /* ===== MAIN CONTENT CARD WITH TABS ===== */
        .dest-card { background: #fff; border: 1.5px solid var(--border-light); border-radius: 20px; overflow: hidden; margin-bottom: 24px; }

        /* Tab bar */
        .dest-tabs { display: flex; border-bottom: 2px solid var(--border-light); background: var(--bg-light); }
        .dest-tab { flex: 1; padding: 16px 12px; border: none; background: transparent; font-family: 'Poppins', sans-serif; font-size: 15px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.18s; border-bottom: 3px solid transparent; margin-bottom: -2px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .dest-tab:hover { color: var(--primary); background: rgba(99,102,241,0.04); }
        .dest-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; font-weight: 700; }

        /* Tab panels */
        .dest-tab-panel { display: none; padding: 24px; }
        .dest-tab-panel.active { display: block; }

        /* Quick stats row */
        .dest-quick-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .dest-stat-card { background: var(--bg-light); border: 1.5px solid var(--border-light); border-radius: 10px; padding: 8px 6px; text-align: center; }
        .dest-stat-icon { font-size: 18px; margin-bottom: 2px; }
        .dest-stat-label { font-size: 10px; text-transform: uppercase; font-weight: 600; color: var(--text-muted); letter-spacing: 0.3px; }
        .dest-stat-value { font-size: 13px; font-weight: 700; color: var(--text-primary); margin-top: 1px; line-height: 1.2; }

        /* Detail section inside tab */
        .dest-section-title { font-size: 14px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 20px 0 10px; }
        .dest-section-title:first-child { margin-top: 0; }

        /* Detail grid inside sections */
        .dest-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .dest-detail-item { background: var(--bg-light); padding: 12px 16px; border-radius: 10px; }
        .dest-detail-item-label { font-size: 11px; text-transform: uppercase; font-weight: 600; color: var(--text-muted); }
        .dest-detail-item-value { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-top: 2px; }

        .dest-nearby-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .dest-nearby-tag { background: var(--bg-light); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; }

        .dest-alerts-list { list-style: none; padding: 0; margin: 0; }
        .dest-alerts-list li { padding: 10px 0; border-bottom: 1px solid var(--border-light); font-size: 14px; }
        .dest-alerts-list li:last-child { border-bottom: none; }

        /* Calendar section */
        .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; }
        .cal-month-nav { display: flex; align-items: center; gap: 12px; }
        .cal-month-nav button { width: 34px; height: 34px; border-radius: 50%; border: 1.5px solid var(--border-light); background: #fff; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .cal-month-nav button:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cal-month-title { font-size: 18px; font-weight: 700; min-width: 160px; text-align: center; }
        .cal-legend { display: flex; gap: 12px; flex-wrap: wrap; }
        .cal-legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; color: var(--text-secondary); }
        .cal-legend-dot { width: 14px; height: 14px; border-radius: 4px; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day-header { text-align: center; font-size: 12px; font-weight: 700; color: var(--text-muted); padding: 6px 0; text-transform: uppercase; }
        .cal-day { position: relative; aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; font-size: 13px; font-weight: 600; border: 1.5px solid transparent; }
        .cal-day:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(0,0,0,0.12); z-index: 1; }
        .cal-day.empty { background: none; cursor: default; }
        .cal-day.empty:hover { transform: none; box-shadow: none; }
        .cal-day.today { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99,102,241,0.25); }
        .cal-day-num { font-size: 14px; font-weight: 700; line-height: 1; }
        .cal-day-pct { font-size: 9px; font-weight: 600; opacity: 0.8; margin-top: 2px; }
        .cal-day-holiday { position: absolute; top: 3px; right: 5px; font-size: 8px; }

        /* Calendar tooltip */
        .cal-tooltip { display: none; position: fixed; background: #1a1a2e; color: #fff; padding: 12px 16px; border-radius: 10px; font-size: 13px; z-index: 9999; pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,0.25); min-width: 180px; }
        .cal-tooltip.show { display: block; }
        .cal-tooltip-date { font-weight: 700; margin-bottom: 6px; font-size: 14px; }
        .cal-tooltip-row { display: flex; justify-content: space-between; gap: 12px; padding: 2px 0; }

        /* CTA row */
        .dest-cta-row { display: flex; gap: 12px; margin-top: 24px; }
        .dest-cta-row button { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 15px; }

        @media (max-width: 600px) {
            .dest-hero-name { font-size: 22px; }
            .dest-detail-grid { grid-template-columns: 1fr; }
            .cal-day { font-size: 11px; }
            .cal-day-num { font-size: 12px; }
            .cal-day-pct { font-size: 8px; }
            .dest-quick-stats { grid-template-columns: repeat(2, 1fr); }
            .dest-tab { font-size: 13px; padding: 14px 8px; }
        }
    </style>
</head>
<body>
    <div class="dest-page" id="destPage">
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 40px; margin-bottom: 12px;">‚è≥</div>
            <p>Loading destination...</p>
        </div>
    </div>

    <!-- Calendar tooltip (shared) -->
    <div class="cal-tooltip" id="calTooltip"></div>

    <!-- Scripts (same order as index.html) -->
    <script src="config.js"></script>
    <script src="data.js"></script>
    <script src="js/festival-service.js"></script>
    <script src="js/weather-service.js"></script>
    <script src="js/accuracy-tracker.js"></script>
    <script src="js/destination-photos.js"></script>
    <script src="js/gamification/points-engine.js"></script>
    <script src="js/gamification/badge-system.js"></script>
    <script src="api-service.js"></script>
    <script src="client-algorithm.js?v=3.0"></script>
    <script>
    // ========== DESTINATION PAGE LOGIC ==========
    (function() {
        const params = new URLSearchParams(window.location.search);
        const destId = parseInt(params.get('id'), 10);
        if (!destId) { window.location.href = 'index.html'; return; }

        const dest = destinations.find(d => d.id === destId);
        if (!dest) { window.location.href = 'index.html'; return; }

        // --- helpers ---
        function getCrowdLabel(level) {
            if (typeof level === 'string') {
                const labels = { low: 'üü¢ Low Crowd', moderate: 'üü° Moderate', heavy: 'üü† Heavy Crowd', overcrowded: 'üî¥ Overcrowded' };
                return labels[level] || level;
            }
            if (level <= 35) return 'üü¢ Low Crowd';
            if (level <= 55) return 'üü° Moderate';
            if (level <= 75) return 'üü† Heavy Crowd';
            return 'üî¥ Overcrowded';
        }
        function normalizeCrowdLevel(level) {
            if (typeof level === 'string') return level;
            if (level <= 35) return 'low';
            if (level <= 55) return 'moderate';
            if (level <= 75) return 'heavy';
            return 'overcrowded';
        }
        function formatCategory(cat) {
            if (!cat) return 'General';
            return cat.charAt(0).toUpperCase() + cat.slice(1).replace('-', ' ');
        }

        // Derive numeric base crowd level from raw data
        const baseCrowdLevel = typeof dest.crowdLevel === 'number'
            ? dest.crowdLevel
            : { 'low': 25, 'moderate': 50, 'heavy': 70, 'overcrowded': 90 }[dest.crowdLevel] || 50;

        // Use prediction algorithm for time/day/season-aware crowd level
        let dynamicCrowdLevel = normalizeCrowdLevel(dest.crowdLevel);
        let closedMessage = null;
        if (window.clientCrowdAlgorithm) {
            try {
                const predicted = window.clientCrowdAlgorithm.calculateCrowdScore({
                    baseCrowdLevel,
                    category: dest.category || 'default',
                    destinationId: dest.id
                });
                if (predicted.status === 'closed') {
                    dynamicCrowdLevel = 'closed';
                    closedMessage = predicted.message || 'Currently closed';
                } else {
                    dynamicCrowdLevel = predicted.level || dynamicCrowdLevel;
                }
            } catch(_){}
        }

        // Best time helper
        function getBestTimeNow() {
            try {
                if (window.clientCrowdAlgorithm) {
                    const r = window.clientCrowdAlgorithm.getBestTimeToday(baseCrowdLevel, dest.category || 'default', dest.id);
                    if (r && r.bestTime) return r.bestTime;
                }
            } catch(_){}
            const h = new Date().getHours();
            if (h >= 6 && h < 9) return '6:00 AM - 9:00 AM';
            if (h < 16) return '4:00 PM - 6:00 PM';
            return '6:00 AM - 9:00 AM';
        }

        // Populate dest metadata
        const crowdLabel = getCrowdLabel(dynamicCrowdLevel);
        const bestTime = getBestTimeNow();
        const bestTimeBadge = bestTime === 'Closed today' ? 'üîí Closed Today' : `‚è∞ ${bestTime}`;
        const weather = typeof dest.weather === 'object'
            ? `${dest.weather.temp}¬∞C, ${dest.weather.condition}`
            : dest.weather || 'N/A';

        // Visitor range (low ~60% of avg, high ~150% of avg)
        function fmtVisitors(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (n >= 1000) return Math.round(n / 1000) + 'k';
            return n.toLocaleString();
        }
        const avgV = dest.avgVisitors || 5000;
        const visitorRange = `${fmtVisitors(Math.round(avgV * 0.6))} ‚Äì ${fmtVisitors(Math.round(avgV * 1.5))}`;

        // Set page title
        document.title = `${dest.name} - CrowdWise India`;

        // --- Nearby attractions ---
        const nearbyHTML = dest.nearbyAttractions && dest.nearbyAttractions.length > 0
            ? dest.nearbyAttractions.map(a => `<span class="dest-nearby-tag">${a}</span>`).join('')
            : '<span class="dest-nearby-tag">No nearby attractions listed</span>';

        // --- Alerts ---
        const alertsHTML = dest.alerts && dest.alerts.length > 0
            ? dest.alerts.map(a => `<li>‚ö†Ô∏è ${a}</li>`).join('')
            : '<li>No special alerts</li>';

        // Build page
        document.getElementById('destPage').innerHTML = `
            <a href="index.html" class="dest-back">‚Üê Back to all destinations</a>

            <!-- Hero -->
            <div class="dest-hero" id="destHero">
                <div class="dest-hero-img" id="destHeroImg"></div>
                <div class="dest-hero-overlay"></div>
                <div class="dest-hero-info">
                    <div class="dest-hero-name">${dest.emoji} ${dest.name}</div>
                    <div class="dest-hero-state">üìç ${dest.city || dest.state}, ${dest.state}</div>
                    <div class="dest-hero-badges">
                        <span class="dest-hero-badge crowd">${crowdLabel}</span>
                        <span class="dest-hero-badge best-time">${bestTimeBadge}</span>
                    </div>
                </div>
            </div>

            <!-- Main content card with tabs -->
            <div class="dest-card">

                <!-- Tab bar -->
                <div class="dest-tabs">
                    <button class="dest-tab active" id="dtab-ov" onclick="switchDestTab('overview')">üìä Overview</button>
                    <button class="dest-tab" id="dtab-cal" onclick="switchDestTab('calendar')">üìÖ Crowd Calendar</button>
                </div>

                <!-- Tab 1: Overview -->
                <div class="dest-tab-panel active" id="dpanel-ov">

                    <!-- Quick stats -->
                    <div class="dest-quick-stats">
                        ${dynamicCrowdLevel === 'closed'
                            ? `<div class="dest-stat-card">
                                <div class="dest-stat-icon">‚ö´</div>
                                <div class="dest-stat-label">Status</div>
                                <div class="dest-stat-value" style="font-size:12px;color:#6b7280;">${closedMessage || 'Currently Closed'}</div>
                               </div>`
                            : `<div class="dest-stat-card">
                                <div class="dest-stat-icon">üë•</div>
                                <div class="dest-stat-label">Daily Visitors</div>
                                <div class="dest-stat-value" style="font-size:13px">${visitorRange}</div>
                               </div>`
                        }
                        <div class="dest-stat-card">
                            <div class="dest-stat-icon">üî•</div>
                            <div class="dest-stat-label">Peak Hours</div>
                            <div class="dest-stat-value">${dest.peakHours || 'N/A'}</div>
                        </div>
                        <div class="dest-stat-card">
                            <div class="dest-stat-icon">üå°Ô∏è</div>
                            <div class="dest-stat-label">Weather</div>
                            <div class="dest-stat-value">${weather}</div>
                        </div>
                        <div class="dest-stat-card">
                            <div class="dest-stat-icon">üè∑Ô∏è</div>
                            <div class="dest-stat-label">Category</div>
                            <div class="dest-stat-value">${formatCategory(dest.category)}</div>
                        </div>
                    </div>

                    <!-- Current Status -->
                    <div class="dest-section-title">üìä Current Status &amp; Best Time</div>
                    <div class="dest-detail-grid">
                        <div class="dest-detail-item">
                            <div class="dest-detail-item-label">Right Now</div>
                            <div class="dest-detail-item-value">${crowdLabel}</div>
                        </div>
                        <div class="dest-detail-item">
                            <div class="dest-detail-item-label">Best Today</div>
                            <div class="dest-detail-item-value">üü¢ ${bestTime}</div>
                        </div>
                        <div class="dest-detail-item">
                            <div class="dest-detail-item-label">Best Season</div>
                            <div class="dest-detail-item-value">${dest.bestTimeToVisit || dest.bestTime || 'Year-round'}</div>
                        </div>
                        <div class="dest-detail-item">
                            <div class="dest-detail-item-label">Peak Hours</div>
                            <div class="dest-detail-item-value">${dest.peakHours || 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Alerts & Tips -->
                    <div class="dest-section-title">‚ö†Ô∏è Alerts &amp; Tips</div>
                    <ul class="dest-alerts-list">${alertsHTML}</ul>

                    <!-- Nearby Attractions -->
                    <div class="dest-section-title">üìç Nearby Attractions</div>
                    <div class="dest-nearby-tags">${nearbyHTML}</div>

                </div>

                <!-- Tab 2: Crowd Calendar -->
                <div class="dest-tab-panel" id="dpanel-cal">
                    <div id="calendarContainer"></div>
                </div>

            </div>

            <!-- Bottom CTA -->
            <div class="dest-cta-row">
                <button onclick="window.location.href='index.html'" style="background: var(--bg-light); color: var(--text-primary);">‚Üê Back</button>
            </div>
        `;

        // Load hero photo
        if (window.DestinationPhotos) {
            window.DestinationPhotos.fetchPhoto(destId).then(url => {
                if (url) {
                    document.getElementById('destHeroImg').style.backgroundImage = `url('${url}')`;
                }
            });
        }

        // ========== CALENDAR LOGIC ==========
        // baseCrowdLevel is already declared above for the crowd prediction
        let yearData = null; // lazy-loaded
        let currentCalMonth = new Date().getMonth();
        let currentCalYear = new Date().getFullYear();

        function getYearData() {
            if (!yearData) {
                yearData = window.clientCrowdAlgorithm.predictYear({
                    baseCrowdLevel,
                    category: dest.category || 'default',
                    destinationId: dest.id
                });
            }
            return yearData;
        }

        function colorForScore(score) {
            if (score < 0.25) return '#dcfce7'; // green-100
            if (score < 0.40) return '#bbf7d0'; // green-200
            if (score < 0.55) return '#fef9c3'; // yellow-100
            if (score < 0.70) return '#fed7aa'; // orange-200
            if (score < 0.85) return '#fecaca'; // red-200
            return '#fca5a5'; // red-300
        }
        function textForScore(score) {
            if (score < 0.40) return '#166534';
            if (score < 0.55) return '#854d0e';
            if (score < 0.70) return '#9a3412';
            return '#991b1b';
        }

        function renderCalendar() {
            const data = getYearData();
            const firstOfMonth = new Date(currentCalYear, currentCalMonth, 1);
            const lastOfMonth = new Date(currentCalYear, currentCalMonth + 1, 0);
            const startDow = firstOfMonth.getDay(); // 0=Sun
            const daysInMonth = lastOfMonth.getDate();
            const monthName = firstOfMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const todayStr = new Date().toISOString().split('T')[0];

            let html = `
                <div class="cal-header">
                    <div class="cal-month-nav">
                        <button onclick="changeCalMonth(-1)" aria-label="Previous month">&#8249;</button>
                        <div class="cal-month-title">${monthName}</div>
                        <button onclick="changeCalMonth(1)" aria-label="Next month">&#8250;</button>
                    </div>
                    <div class="cal-legend">
                        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#dcfce7;"></div> Low</div>
                        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fef9c3;"></div> Moderate</div>
                        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fed7aa;"></div> Heavy</div>
                        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#fca5a5;"></div> Packed</div>
                    </div>
                </div>
                <div class="cal-grid">
            `;

            // Day headers (Sun‚ÄìSat)
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                html += `<div class="cal-day-header">${d}</div>`;
            });

            // Empty cells before first day
            for (let i = 0; i < startDow; i++) {
                html += '<div class="cal-day empty"></div>';
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentCalYear}-${String(currentCalMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const info = data[dateStr];
                const isToday = dateStr === todayStr;

                if (info) {
                    const bg = colorForScore(info.score);
                    const fg = textForScore(info.score);
                    const holidayDot = info.holiday ? '<span class="cal-day-holiday">üéâ</span>' : '';
                    html += `<div class="cal-day ${isToday ? 'today' : ''}" style="background:${bg}; color:${fg};"
                        onmouseenter="showCalTooltip(event, '${dateStr}')"
                        onmouseleave="hideCalTooltip()"
                        ontouchstart="showCalTooltip(event, '${dateStr}')"
                        >
                        ${holidayDot}
                        <span class="cal-day-num">${day}</span>
                        <span class="cal-day-pct">${info.percentFull}%</span>
                    </div>`;
                } else {
                    // Date is outside prediction range ‚Äî show greyed out
                    html += `<div class="cal-day empty" style="background:#f9fafb; color:#d1d5db;">
                        <span class="cal-day-num">${day}</span>
                    </div>`;
                }
            }

            html += '</div>';
            document.getElementById('calendarContainer').innerHTML = html;
        }

        // Month navigation
        window.changeCalMonth = function(dir) {
            currentCalMonth += dir;
            if (currentCalMonth > 11) { currentCalMonth = 0; currentCalYear++; }
            if (currentCalMonth < 0) { currentCalMonth = 11; currentCalYear--; }

            // Clamp to valid range (current month to +12 months)
            const now = new Date();
            const minDate = new Date(now.getFullYear(), now.getMonth(), 1);
            const maxDate = new Date(now.getFullYear() + 1, now.getMonth(), 1);
            const curDate = new Date(currentCalYear, currentCalMonth, 1);
            if (curDate < minDate) { currentCalMonth = minDate.getMonth(); currentCalYear = minDate.getFullYear(); }
            if (curDate > maxDate) { currentCalMonth = maxDate.getMonth(); currentCalYear = maxDate.getFullYear(); }

            renderCalendar();
        };

        // Tooltip
        window.showCalTooltip = function(event, dateStr) {
            const data = getYearData();
            const info = data[dateStr];
            if (!info) return;
            const tooltip = document.getElementById('calTooltip');
            const d = new Date(dateStr + 'T12:00:00');
            const dayName = d.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            tooltip.innerHTML = `
                <div class="cal-tooltip-date">${dayName}</div>
                <div class="cal-tooltip-row"><span>Crowd</span><span>${info.emoji} ${info.label}</span></div>
                <div class="cal-tooltip-row"><span>Level</span><span>${info.percentFull}% full</span></div>
                ${info.holiday ? `<div class="cal-tooltip-row"><span>üéâ</span><span>${info.holiday}</span></div>` : ''}
                ${info.isWeekend ? `<div class="cal-tooltip-row"><span>üìÖ</span><span>Weekend</span></div>` : ''}
            `;
            // Position tooltip near cursor
            const rect = event.target.closest('.cal-day').getBoundingClientRect();
            tooltip.style.top = (rect.bottom + 8) + 'px';
            tooltip.style.left = Math.min(rect.left, window.innerWidth - 220) + 'px';
            tooltip.classList.add('show');
        };

        window.hideCalTooltip = function() {
            document.getElementById('calTooltip').classList.remove('show');
        };

        // Tab switching
        window.switchDestTab = function(tab) {
            const isCalendar = tab === 'calendar';
            document.getElementById('dtab-ov').classList.toggle('active', !isCalendar);
            document.getElementById('dtab-cal').classList.toggle('active', isCalendar);
            document.getElementById('dpanel-ov').classList.toggle('active', !isCalendar);
            document.getElementById('dpanel-cal').classList.toggle('active', isCalendar);
            // Lazy-render calendar on first open
            if (isCalendar && !window._calRendered) {
                window._calRendered = true;
                renderCalendar();
            }
        };

    })();
    </script>
</body>
</html>
